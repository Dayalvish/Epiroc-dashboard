<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EPIROC FLEET MONITOR - REGIONAL ACCESS</title>
    
    <style>
        /* --- BRANDING & COLOR PALETTE --- */
        :root { 
            --epiroc-yellow: #f1c40f; 
            --background: #0d0d0d; 
            --card-surface: #1a1a1a; 
            --status-red: #ff4d4d; 
            --status-green: #2ecc71; 
            --text-dim: #95a5a6;
        }

        /* --- GLOBAL RESET --- */
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background-color: var(--background); 
            color: #ffffff; 
            margin: 0; 
            padding: 20px; 
            overflow: hidden; /* Prevent scrolling until login */
        }

        /* --- NEW PROFESSIONAL LOGIN GRID --- */
        #login-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: var(--background);
            display: flex; justify-content: center; align-items: center;
            z-index: 10000;
        }

        .login-grid {
            background: var(--card-surface);
            padding: 50px;
            border-radius: 12px;
            border: 2px solid var(--epiroc-yellow);
            width: 400px;
            text-align: center;
            box-shadow: 0 20px 50px rgba(0,0,0,0.8);
        }

        .login-grid img { height: 60px; margin-bottom: 30px; }
        .login-grid h2 { color: var(--epiroc-yellow); text-transform: uppercase; margin-bottom: 30px; letter-spacing: 2px; }

        .input-box { width: 100%; padding: 15px; margin-bottom: 15px; background: #000; border: 1px solid #444; color: #fff; border-radius: 6px; box-sizing: border-box; font-size: 1rem; }
        
        .remember-section { display: flex; align-items: center; gap: 10px; margin-bottom: 25px; color: var(--text-dim); font-size: 0.9rem; }

        .login-button { width: 100%; padding: 15px; background: var(--epiroc-yellow); color: #000; border: none; font-weight: bold; border-radius: 6px; cursor: pointer; font-size: 1.1rem; transition: 0.3s; }
        .login-button:hover { background: #fff; transform: scale(1.02); }

        #login-error { color: var(--status-red); margin-top: 15px; display: none; font-weight: bold; }

        /* --- DASHBOARD STYLES (HIDDEN UNTIL LOGIN) --- */
        #main-dashboard { display: none; }
        
        .header-panel { display: flex; justify-content: space-between; border-bottom: 3px solid var(--epiroc-yellow); padding-bottom: 20px; margin-bottom: 30px; }
        
        .controls { background: var(--card-surface); padding: 20px; border-radius: 10px; margin-bottom: 30px; display: flex; gap: 25px; align-items: center; border: 1px solid #333; }
        .controls select, .controls input { padding: 12px; background: #000; color: #fff; border: 1px solid #444; border-radius: 6px; min-width: 220px; }

        .diagnostic-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }
        .metric-card { background: var(--card-surface); padding: 20px; border-radius: 12px; border-left: 5px solid var(--epiroc-yellow); }
        .metric-title { color: var(--epiroc-yellow); font-size: 0.8rem; font-weight: bold; text-transform: uppercase; border-bottom: 1px solid #333; padding-bottom: 8px; margin-bottom: 12px; }
        .metric-value { font-size: 2.2rem; font-weight: bold; display: block; }
        .metric-unit { font-size: 0.8rem; color: var(--text-dim); text-transform: uppercase; }

        /* ALERTS */
        .alert-active { color: var(--status-red) !important; animation: blinker 1s infinite; }
        @keyframes blinker { 50% { opacity: 0.3; } }
    </style>
</head>
<body>

<div id="login-overlay">
    <div class="login-grid">
        <img src="https://raw.githubusercontent.com/Dayalvish/Epiroc-dash/main/Picture1.png">
        <h2>Regional Access</h2>
        <input type="text" id="username" class="input-box" placeholder="User ID (e.g., Ranchi_Adm)">
        <input type="password" id="password" class="input-box" placeholder="Password">
        
        <div class="remember-section">
            <input type="checkbox" id="rememberMe">
            <label for="rememberMe">Remember User ID</label>
        </div>

        <button class="login-button" onclick="handleLogin()">Login to Dashboard</button>
        <div id="login-error">Invalid Credentials. Access Denied.</div>
    </div>
</div>

<div id="main-dashboard">
    <header class="header-panel">
        <div>
            <h1 id="region-title" style="margin:0; color:var(--epiroc-yellow);">EPIROC FLEET MONITOR</h1>
            <div id="user-display" style="color:var(--text-dim); font-size:0.9rem;">Connecting to Database...</div>
        </div>
        <img src="https://raw.githubusercontent.com/Dayalvish/Epiroc-dash/main/Picture1.png" height="50">
    </header>

    <div class="controls">
        <select id="rigDropdown" onchange="loadData()"><option value="">-- Select Rig --</option></select>
        <input type="month" id="monthPicker" onchange="loadData()">
        <span id="sync-msg" style="color:var(--epiroc-yellow); display:none;">⏳ Syncing...</span>
    </div>

    <div class="diagnostic-grid">
        <div class="metric-card"><div class="metric-title">Engine RPM</div><span id="val-rpm" class="metric-value">--</span><span class="metric-unit">RPM</span></div>
        <div class="metric-card"><div class="metric-title">Oil Press</div><span id="val-oil" class="metric-value">--</span><span id="unit-oil" class="metric-unit">BAR</span></div>
        <div class="metric-card"><div class="metric-title">Eng Temp</div><span id="val-temp" class="metric-value">--</span><span id="unit-temp" class="metric-unit">°C</span></div>
        <div class="metric-card"><div class="metric-title">Fuel Press (N)</div><span id="val-fuel" class="metric-value">--</span><span class="metric-unit">BAR</span></div>
        <div class="metric-card"><div class="metric-title">Receiver NL (O)</div><span id="val-rec" class="metric-value">--</span><span class="metric-unit">BAR</span></div>
        <div class="metric-card"><div class="metric-title">Hyd Temp (AI)</div><span id="val-hyd" class="metric-value">--</span><span id="unit-hyd" class="metric-unit">°C</span></div>
        <div class="metric-card"><div class="metric-title">Charging (AO)</div><span id="val-volt" class="metric-value">--</span><span id="unit-volt" class="metric-unit">VOLTS</span></div>
        <div class="metric-card"><div class="metric-title">Eng Load (J)</div><span id="val-load" class="metric-value">--</span><span class="metric-unit">%</span></div>
    </div>
</div>

<script>
    const API = "REPLACE_WITH_YOUR_DEPLOYED_URL";
    let activeRegion = "All";

    // CHECK REMEMBERED USER
    window.onload = () => {
        const saved = localStorage.getItem('epi_uid');
        if (saved) {
            document.getElementById('username').value = saved;
            document.getElementById('rememberMe').checked = true;
        }
    };

    // PROFESSIONAL LOGIN HANDLER
    async function handleLogin() {
        const u = document.getElementById('username').value;
        const p = document.getElementById('password').value;
        const rem = document.getElementById('rememberMe').checked;
        const err = document.getElementById('login-error');

        if(!u || !p) return;

        try {
            const res = await fetch(`${API}?get=login&user=${encodeURIComponent(u)}&pass=${encodeURIComponent(p)}`);
            const data = await res.json();

            if(data.success) {
                // Save user ID if requested
                if(rem) localStorage.setItem('epi_uid', u);
                else localStorage.removeItem('epi_uid');

                activeRegion = data.region;
                
                // Switch Views
                document.getElementById('login-overlay').style.display = 'none';
                document.getElementById('main-dashboard').style.display = 'block';
                document.body.style.overflow = 'auto';
                
                document.getElementById('region-title').innerText = `EPIROC MONITOR - ${activeRegion}`;
                document.getElementById('user-display').innerText = `User: ${data.name} | Access: ${activeRegion}`;
                
                initDashboard();
            } else {
                err.style.display = 'block';
            }
        } catch (e) { alert("API Connection Error"); }
    }

    async function initDashboard() {
        const res = await fetch(`${API}?get=list&userRegion=${activeRegion}`);
        const rigs = await res.json();
        document.getElementById('rigDropdown').innerHTML = rigs.map(r => `<option value="${r}">${r}</option>`).join('');
        if(rigs.length > 0) loadData();
    }

    async function loadData() {
        const rig = document.getElementById('rigDropdown').value;
        const m = document.getElementById('monthPicker').value;
        if(!rig) return;

        document.getElementById('sync-msg').style.display = 'inline';
        
        try {
            const res = await fetch(`${API}?fleetId=${encodeURIComponent(rig)}&month=${m}&userRegion=${activeRegion}`);
            const d = await res.json();
            const latest = d.latest, limits = d.limits;

            // Map data from ParameterDb columns
            document.getElementById('val-rpm').innerText = latest[7];
            document.getElementById('val-load').innerText = latest[9];
            document.getElementById('val-fuel').innerText = latest[13];
            document.getElementById('val-rec').innerText = latest[14];

            // Oil Threshold Check
            const oilVal = parseFloat(latest[11]);
            const oilEl = document.getElementById('val-oil');
            oilEl.innerText = oilVal;
            if (oilVal < limits.oilLimit) {
                oilEl.className = "metric-value alert-active";
                document.getElementById('unit-oil').innerText = `⚠️ LOW (Threshold: ${limits.oilLimit})`;
            } else {
                oilEl.className = "metric-value";
                document.getElementById('unit-oil').innerText = "BAR";
            }

            // Temp Alert
            const tempVal = parseFloat(latest[8]);
            const tempEl = document.getElementById('val-temp');
            tempEl.innerText = tempVal;
            if (tempVal > limits.tempLimit) {
                tempEl.className = "metric-value alert-active";
                document.getElementById('unit-temp').innerText = `⚠️ HIGH (Threshold: ${limits.tempLimit})`;
            } else {
                tempEl.className = "metric-value";
                document.getElementById('unit-temp').innerText = "°C";
            }

            // Voltage & Hyd Alerts
            const v = parseFloat(latest[40]), h = parseFloat(latest[34]);
            document.getElementById('val-volt').innerText = v;
            document.getElementById('val-volt').className = (v < 24 || v > 29) ? "metric-value alert-active" : "metric-value";
            document.getElementById('val-hyd').innerText = h;
            document.getElementById('val-hyd').className = (h > 85) ? "metric-value alert-active" : "metric-value";

        } catch (e) { console.error("Sync Error"); }
        document.getElementById('sync-msg').style.display = 'none';
    }
</script>
</body>
</html>
